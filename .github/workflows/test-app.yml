name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    # Install Dependencies
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install Dependencies
      run: |
        npm install

    # Build the app
    - name: Build the App
      run: |
        npm run build

    # Run the server (if needed, replace with your command to start the server)
    - name: Run Server
      run: |
        npm run start & # Run in background (assuming it's a long-running process)
        sleep 10 # Allow server to start

    # Execute Cypress Tests with Mochawesome Report
    - name: Run Cypress Tests
      run: |
        npm run cypress:run --reporter mochawesome --reporter-options reportDir=cypress/reports,reportFilename=index
      continue-on-error: true # Ensure this step doesn't fail the job

    # Merge Mochawesome Reports
    - name: Merge Mochawesome Reports
      run: |
        npx mochawesome-merge cypress/results/mochawesome.json > cypress/results/report.json
        npx mochawesome-report-generator cypress/results/report.json -o cypress/results/html

    # Send the report to Slack using Webhook
    - name: Send Report to Slack
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        curl -X POST -H 'Content-type: application/json' --data @cypress/results/html/index.html $SLACK_WEBHOOK
